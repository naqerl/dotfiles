#!/usr/bin/env bash
set -e

STATE_FILE=/tmp/batmon-state
STEP=10

status=$(acpi -b)
if echo $status | grep -ic "discharging"; then
    percentage=$(echo $status | awk -F ', ' '{print substr($2, 0, length($2)-1)}')
    if [[ ! -f $STATE_FILE ]]; then
        echo 100 > "$STATE_FILE"
    fi
    next_boundary=$(cat $STATE_FILE)
    echo "percentage: $percentage, prev charge $next_boundary"
    if (( percentage <= next_boundary)); then
        if (( percentage <= 20 )); then
            # We need charging
            notify-send --urgency critical "low battery ($percentage%)"
        elif (( percentage <= 70 )); then
            # Have some charge, but highlight how much time left
            notify-send --urgency normal "$percentage% of battery left"
        fi
        floored=$((percentage / STEP * STEP))
        echo $((floored - STEP)) > "$STATE_FILE"
    fi
else
    rm -f "$STATE_FILE"
fi

exec snooze -H* -M*  $0
