; Depends on plyaerctl, mpv-mpris
(defpoll time :interval "5s" `date +'{"h": "%H", "m": "%M"}'`)

(defvar current_workspace_name "?")

(defvar notification_reveal false)
(defvar notification_text "")

(defvar warning_cpu_temp 55)
(defvar warning_used_mem_perc 80)

(defpoll volume_percent :interval "1h" `$HOME/.config/eww/scripts/volume current`)

(deflisten playing_reveal "while true; do if [[ $(playerctl status) == 'Playing' ]]; then echo t; else echo f; fi; sleep 1; done")
(deflisten playing_title "while true; do playerctl metadata title; sleep 1; done")
(defvar playing_reveal_manual "t")

(defvar layout_alert_reveal false)

(defpoll net :interval "10s"
         :initial `0`
         `nmcli -t -f SIGNAL,ACTIVE device wifi | awk -F':' '{ if ($2=="yes") print $1 }'`)

(defpoll wireguard_vpn :interval "5s"
         :initial ``
         `nmcli device | rg pixelplex-vpn | awk '{print "active"}'`)

(defpoll cpu_temp :interval "10s"
         :initial "0"
         `$HOME/.config/eww/scripts/temp`)

(defvar timer69 "")
(defvar timer_color "light")

(defpoll mic_state :interval "0.5s" :initial "" `$HOME/.config/bin/mic-state`)

(defvar emacs_session "")
(defvar emacs_focused "f")
(defvar emacs_window "")
(defvar emacs_window_icon "")
(defvar git_branch "")
(defvar emacs_buffer_modifier "")
(defvar emacs_lsp "")


(defwindow bar
           :geometry (geometry
                       :width "100%"
                       :anchor "top center")
           :monitor 0
           :stacking "bottom"
           :exclusive true
           :namespace eww
           (bar))

(defwidget bar []
           (centerbox :class "box bg-transparent"
                :style "padding: 4px 0;"
                :orientation "h"
                (left)
                (center)
                (right)))

(defwidget left []
           (box
            :orientation "h"
            :space-evenly false
            :halign "start"
            (container
             :bg "dark"
             :right {playing_reveal == 't' && playing_reveal_manual == 't' ? "dark2dark" : "dark"}
             :fg "light"
             (box
              :space-evenly false
              (space)
              (space)
              (text :content current_workspace_name)
              (space)
              (space)))
            (mpv_player)
            (notification)))

(defwidget center []
           (box
            :orientation "h"
            :space-evenly false
            :halign "center"
            (container
             :bg "dark"
             :left "dark"
             :right {emacs_focused == "t" && emacs_buffer_modifier != "" ? "dark2dark" : "dark"}
             :fg "light"
             (box
              :space-evenly false
              (revealer  ;; Left Emacs status
               :transition "slideleft"
               :reveal {emacs_focused == "t"}
               :duration "300ms"
               (box :class "box"
                    :orientation "h"
                    :space-evenly false
                    :hexpand false
                    :halign "start"
                    :width 300
                    (label
                     :class "fg-purple"
                     :text {" "})
                    (label
                     :text emacs_session
                     :limit-width 50)
                    (separator)))
              (revealer
               :transition "slideleft"
               :reveal {mic_state == 'muted' ? false : true}
               :duration "200ms"
               (mic))
              (clock)
              (space)
              (battery_v2)
              (layout_alert)
              (revealer ;; Right Emacs status
               :transition "slideright"
               :reveal {emacs_focused == "t"}
               :duration "300ms"
               (box :class "box"
                    :orientation "h"
                    :space-evenly false
                    :halign "end"
                    :width 300
                    (separator)
                    (box
                     :hexpand true
                     :space-evenly false
                     :halign "end"
                     (label
                      :text emacs_window_icon
                      :limit-width 2)
                     (space)
                     (space)
                     (label
                      :text emacs_window
                      :xalign 1
                      :limit-width 50))))))
            (revealer
             :transition "slideright"
             :reveal {emacs_focused == "t" && emacs_buffer_modifier != ""}
             (container
              :bg "dark"
              :fg "light"
              :right "dark"
              (box (text :content emacs_buffer_modifier :class "fg-yellow"))))
            ))

(defwidget separator []
           (box (space) (space) (space) (space) (space) (space) (space) (space) (space) (space) (space) (space) (space) (space) (space) (space) (space) (space) (space) (space) (space) (space)))

(defwidget right []
           (box :orientation "h"
                :space-evenly false
                :halign "end"
                (revealer
                 :transition "slideleft"
                 :reveal {cpu_temp >= warning_cpu_temp ||  EWW_RAM.used_mem_perc >= warning_used_mem_perc ? true : false}
                 (container
                  :bg "yellow"
                  :fg "dark"
                  :left "yellow"
                  :right "yellow"
                  (box
                   :space-evenly false
                   (revealer
                    :transition "slideleft"
                    :reveal {cpu_temp >= warning_cpu_temp}
                    :duration "250ms"
                    (box
                     :space-evenly
                     (space)
                     (text :content "${cpu_temp}󰔄" :class "fg-dark bg-yellow")
                     (space)))
                   (revealer
                    :transition "slideleft"
                    :reveal {EWW_RAM.used_mem_perc >= warning_used_mem_perc}
                    :duration "250ms"
                    (box
                     :space-evenly false
                     (space)
                     (text :content " ${round(EWW_RAM.used_mem_perc, 0)}%" :class "fg-dark bg-yellow")
                     (space))))))
                (container
                 :left "dark"
                 :bg "dark"
                 :fg "light"
                 (box
                  :space-evenly false
                  (revealer
                   :transition "slideleft"
                   :reveal {timer69 == '' ? false : true}
                   :duration "500ms"
                   (text
                    :class "fg-${timer_color}"
                    :content "${timer69}"))
                  (space)
                  (space)
                  (text
                   :class "fg-${timer_color}"
                   :content " ")
                  (space)
                  (space)))))



(defwidget text [content ?class]
           (label
            :class "text ${class}"
            :text content))

(defwidget container [bg fg ?size ?left ?right]
           (box
             :orientation "horizontal"
             :space-evenly false
             (revealer
              :transition "slideleft"
              :reveal {left != ""}
              (icon
               :path "/home/suzu/Pictures/icons/left-triangle-${left}.svg"
               :size {size != "" ? size : 24}))
            (box
             :class "bg-${bg} fg-${fg}"
             (children))
            (revealer
              :transition "slideright"
              :reveal {right != ""}
              (icon
               :path "/home/suzu/Pictures/icons/right-triangle-${right}.svg"
               :size {size != "" ? size : 24}))))

(defwidget icon [path ?size]
           (image
             :class "icon"
             :path path
             :image-width size
             :image-height size))

(defwidget battery_v2 []
           (overlay 
            :width 20
            :height 20
            (box
                :style "margin: 5px;"
                (circular-progress :value volume_percent
                                   :class "cricle_bar volume_bar"
                                   :thickness 3))
            (box
                :style "padding: 2px;"
                (circular-progress :value {EWW_BATTERY.BAT0.capacity}
                                   :class "circle_bar bat_bar ${EWW_BATTERY.BAT0.status == 'Charging' ? 'battery_charging' : 'battery_discharging'}"
                                   :thickness 3
                                   ))))

(defwidget layout_alert []
            (revealer
             :transition "slideright"
             :reveal layout_alert_reveal
             :duration "250ms"
             (box
              :space-evenly false
              (container
               :left "yellow"
               :right "yellow"
               :bg "yellow"
               :fg "dark"
               (text :content "ru" :class "fg-dark")))))


(defwidget emacs_session []
    (revealer
    :transition "fade"
    :reveal {emacs_focused == "t"}
    :duration "300ms"
    (box :class "box" :orientation "h" :space-evenly false :hexpand false :halign "start"
            (label
            :class "fg-purple"
            :text {" "})
            (label
            :text emacs_session
            :limit-width 50))))

(defwidget emacs_window []
    (revealer
    :transition "fade"
    :reveal {emacs_focused == "t"}
    :duration "300ms"
    :halign "end"
    (box :class "box" :orientation "h" :space-evenly false :halign "end"
        (label
        :text emacs_window_icon
        :xalign 1
        :limit-width 2)
        (space)
        (space)
        (label
        :text emacs_window
        :xalign 1
        :limit-width 50)
        (emacs_buffer_modifier))))

(defwidget emacs_buffer_modifier []
    (revealer
            :transition "slideright"
            :reveal {emacs_buffer_modifier != ""}
            (box :halign "end"
                (space)
                (label
                    :text emacs_buffer_modifier
                    :xalign 1
                    :class "fg-yellow"))))


(defwidget git_branch []
    (revealer
        :transition "fade"
        :reveal {emacs_focused == "t" && git_branch != ""}
        :duration "300ms"
        (box :class "box" :orientation "h" :space-evenly false :hexpand true :width "20px"
            (space)
            (label
            :text {"  "}
            :limit-width 3)
            (label
            :text git_branch
            :limit-width 50)
            (space))))

(defwidget emacs_lsp []
    (box :class "box" :orientation "h" :halign "end"
        (label
            :justify "end"
            :xalign 0
            :class "fg-blue"
            :limit-width 2
            :text emacs_lsp)))

(defwidget emacs_x []
 (box
  :width 200
  :orientation "h"
  :space-evenly false
  :hexpand false
  :halign "start"
  (emacs_session)
  (emacs_lsp)))

(defwidget emacs_y []
 (box
  :orientation "h"
  :halign "end"
  (emacs_window)))

(defwidget emacs_info []
    (revealer
        :transition "fade"
        :reveal {emacs_focused == "t"}
        :duration "300ms"
        (centerbox
            :orientation "h"
            :class "box"
            :space-evenly false
            :width 600
            (emacs_x)
            (space)
            (emacs_y))))

(defwidget timer69 []
(revealer
             :transition "slideleft"
             :reveal {timer69 == '' ? false : true}
             :duration "500ms"
             (box :class "box" :orientation "h" :space-evenly false :hexpand true
                  (space)
                  (label
                    :style {"color: " + timer_color}
                    :text {timer69}
                    :limit-width 35)
                  (space)))
)

(defwidget mic []
             (box :class "mic" :orientation "h" :space-evenly false :hexpand true :width "20px"
                  (space)
                  (label
		    :class "mic"
                    :text " "
                    :limit-width 35)
                  (space)))

(defwidget mpv_player []
           (revealer
             :transition "slideleft"
             :reveal {playing_reveal == 't' && playing_reveal_manual == 't' ? true : false}
             :duration "500ms"
             (container
              :bg "dark"
              :fg "light"
              :right "dark"
              (box :class "bg-dark" :orientation "h" :space-evenly false :hexpand true :width "20px"
                  ; (image :path playing_art :image-height 15)
                  (space)
                  (label
                    :text {'  ' + playing_title}
                    :limit-width 70)
                  (space)))))


(defwidget cpu_temp_alert []
            (label
             :class "cpu_temp_alert"
             :text "${cpu_temp}󰔄 "
             :tooltip "brightness"))

(defwidget ram_alert []
                  (label
                    :class "cpu_temp_alert"
                    :text " ${round(EWW_RAM.used_mem_perc, 0)}%"
                    :tooltip "brightness")
                  )

(defwidget battery []
           (box :class "bat_module" :vexpand "false" :hexpand "false"
                (circular-progress :value {EWW_BATTERY.BAT0.capacity}
                                   :class "circle_bar bat_bar ${EWW_BATTERY.BAT0.status == 'Charging' ? 'battery_charging' : 'battery_discharging'}"
                                   :thickness 3
                                   (button
                                     :class "iconbat"
                                     :tooltip "battery on ${EWW_BATTERY.BAT0.capacity }%"
                                     :onclick "$HOME/.config/eww/scripts/pop system"
                                     " "))))

(defwidget space []
           (box :class "" :vexpand "false" :hexpand "false"
                (label :class "space" :text " ")))

(defwidget clock []
           (eventbox :onhover "eww update time_rev=true"
                     :onhoverlost "eww update time_rev=false"
                     (box :space-evenly "false" :orientation "h" :spacing "2" :class "box"
                          (label :text {time.h} )
                          (label :text "󰇙" :class "clock_time_sep" )
                          (label :text {time.m} ))))

(defwidget workspace []
           (box :space-evenly "false" :orientation "h" :spacing "3"
                (label :text {current_workspace_name == '10' ? '0' : current_workspace_name}  :class "workspace")
                (space)))


(defwidget volume_circle []
           (box :class "bat_module" :vexpand "false" :hexpand "false"
                (circular-progress :value volume_percent
                                   :class "circle_bar volume_bar"
                                   :thickness 3
                                   (button
                                     :class "iconbat"
                                     :tooltip "Volume on ${volume_percent}%"
                                     " "))))

(defwidget notification []
           (revealer
            :transition "slideleft"
            :reveal notification_reveal
            :duration "500ms"
            (container
             :bg "cyan"
             :fg "dark"
             :left "cyan"
             :right "cyan"
             (text :content notification_text :class "fg-dark"))))

(defwidget monitors []
           (box :orientation "h"
                :space-evenly false
                :halign "end"
                :class "box"
                (volume_circle)
                (space)
                (battery)
                ))

(defwidget left_alerts []
           (box :orientation "h"
                :space-evenly false
                :halign "end"
                :class "alerts"
                (workspace)
                (mpv_player)
                (notification)))



(defwidget right_alerts []
           (box :orientation "h"
                :space-evenly false
                :halign "end"
                :class "alerts"
		(mic)
                (layout_alert)
                (cpu_temp_alert)
                (ram_alert)
		(timer69)))





(defwindow powermenu
           :monitor 0
           :stacking "fg"
           :geometry (geometry :width "100%" :height "100%")
           (powermenu_layout))

(defwidget _buttons [shutdown shutdown_icon reboot
                              reboot_icon logout logout_icon]
           (box :class "btns-box" :spacing 5
                :vexpand true :hexpand true
                :valign "end" :halign "end"
                :space-evenly false
                (button :onclick shutdown shutdown_icon)
                (button :onclick reboot reboot_icon)
                (button :onclick logout logout_icon)))

(defwidget _network [strength offline excellent good okay slow]
           (box :class "net-box"
                :space-evenly false
                (label :text {strength == "" ? offline :
                       strength < 26 ? slow :
                       strength < 51 ? okay :
                       strength < 76 ? good : excellent})

                (label :text {wireguard_vpn == 'active' ? "󰖂 " : " "})))

(defwidget powermenu_layout []
           (box :class "layout-box" :space-evenly false :orientation "vertical"
                (box :valign "start" :space-evenly false :spacing 25
                     (_network :strength net :offline "󰣽 " :excellent "󰣺 " :good "󰣸 "
                               :okay "󰣶 " :slow "󰣴 ")
                     )
                (box :space-evenly false :hexpand true :vexpand true
                     (_buttons :shutdown "poweroff" :reboot "reboot"
                               :logout "loginctl kill-session self"
                               :shutdown_icon "󰐥" :reboot_icon "" :logout_icon "󰍃"))))
